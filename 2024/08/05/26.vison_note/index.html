<!DOCTYPE html>
<html>
  <head>
     
    <meta charset="UTF-8">
    <title>一些视觉代码使用的记录 - qllokirin</title>
    <link rel="shortcut icon" href="/static/img/icon.png">
    <link rel="icon" href="/static/img/icon.png" sizes="192x192"/>
    
<link rel="stylesheet" href="/static/kico.css">
<link rel="stylesheet" href="/static/hingle.css">

    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1"/>
    <meta property="og:site_name" content="qllokirin">
    <meta property="og:title" content="一些视觉代码使用的记录"/>
    
<meta name="generator" content="Hexo 6.3.0"></head>

  <body>
    <header>
    <div class="head-title">
        <h4>qllokirin</h4>
    </div>
    <div class="head-action">
        <div class="toggle-btn"></div>
        <div class="light-btn"></div>
        <div class="search-btn"></div>
    </div>
    <form class="head-search" method="post">
        <input type="text" name="s" placeholder="搜索什么？">
    </form>
    <nav class="head-menu">
        <a href="/">首页</a>
        <div class="has-child">
            <a>分类</a>
            <div class="sub-menu">
                <a class="category-link" href="/categories/%E5%88%86%E4%BA%AB/">分享</a><a class="category-link" href="/categories/%E6%95%99%E7%A8%8B/">教程</a><a class="category-link" href="/categories/%E7%94%9F%E6%B4%BB/">生活</a><a class="category-link" href="/categories/%E8%AE%B0%E5%BD%95/">记录</a>
            </div>
        </div>
        
            <a href="/about">关于我</a>
        
            <a href="/friends">朋友们</a>
        
    </nav>
</header>

    <main>
    <div class="wrap min">
        <section class="post-title">
            <h2>一些视觉代码使用的记录</h2>
            <div class="post-meta">
                <time class="date">2024.08.05</time>
            
                <span class="category"><a class="category-link" href="/categories/%E8%AE%B0%E5%BD%95/">记录</a></span>
            
            </div>
        </section>
        <article class="post-content">
        
            <p>做了这么久的比赛，虽然已经离队了，不过还是总结一下与视觉联调的时候总结的一些小问题</p>
<span id="more"></span>

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>此篇仅做记录，对视觉算法等等涉入尚欠，想必会有很多纰漏与错误。比赛中主要的任务就是识别圆与神经网络分类，故从这两个任务进行记录。</p>
<h1 id="识别圆"><a href="#识别圆" class="headerlink" title="识别圆"></a>识别圆</h1><h3 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h3><p>具体使用与调参我也不懂，只是近日看学弟的代码发现六七个参数就能有比较好的效果了，微做感叹。</p>
<h3 id="标定"><a href="#标定" class="headerlink" title="标定"></a>标定</h3><blockquote>
<p>参考<a target="_blank" rel="noopener" href="http://wiki.ros.org/camera_calibration/Tutorials/MonocularCalibration">官方教程</a>，<a target="_blank" rel="noopener" href="https://blog.csdn.net/heyijia0327/article/details/43538695">补充</a></p>
</blockquote>
<p>这主要是需要使用相机内参矩阵计算<strong>圆心距离无人机中心水平坐标差</strong>，不过说起来，其实每次标定计算内参的时候，浮动还挺大的，上下浮动几十吧，不清楚到底是什么问题，不过用起来还可以，挺好的。以前总以为越清晰越好，现在感觉，就咱这识别任务，480p足以，糊一点还免的高斯模糊了（不是）</p>
<p>1.安装usb_cam包</p>
<pre><code>sudo apt install ros-noetic-usb-cam
</code></pre>
<p>2.启动相机</p>
<pre><code>roslaunch usb_cam usb_cam-test.launch
</code></pre>
<blockquote>
<p>若是使用自己的笔记本（有摄像头的话），大概率需要修改<code>/dev/video0</code>为<code>/dev/video2</code>或者<code>/dev/video4</code>，把下面的内容写入<code>usb_cam.launch</code>后使用<code>roslaunch ./usb_cam.launch</code>启动即可，或者<code>sudo vim /opt/ros/noetic/share/usb_cam/launch/usb_cam-test.launch</code>直接修改原launch也可以</p>
<pre><code>&lt;launch&gt;
  &lt;node name=&quot;usb_cam&quot; pkg=&quot;usb_cam&quot; type=&quot;usb_cam_node&quot; output=&quot;screen&quot; &gt;
    &lt;param name=&quot;video_device&quot; value=&quot;/dev/video0&quot; /&gt;
    &lt;param name=&quot;image_width&quot; value=&quot;640&quot; /&gt;
    &lt;param name=&quot;image_height&quot; value=&quot;480&quot; /&gt;
    &lt;param name=&quot;pixel_format&quot; value=&quot;yuyv&quot; /&gt;
    &lt;param name=&quot;color_format&quot; value=&quot;yuv422p&quot; /&gt;
    &lt;param name=&quot;camera_frame_id&quot; value=&quot;usb_cam&quot; /&gt;
    &lt;param name=&quot;io_method&quot; value=&quot;mmap&quot;/&gt;
  &lt;/node&gt;
  &lt;node name=&quot;image_view&quot; pkg=&quot;image_view&quot; type=&quot;image_view&quot; respawn=&quot;false&quot; output=&quot;screen&quot;&gt;
    &lt;remap from=&quot;image&quot; to=&quot;/usb_cam/image_raw&quot;/&gt;
    &lt;param name=&quot;autosize&quot; value=&quot;true&quot; /&gt;
  &lt;/node&gt;
&lt;/launch&gt;
</code></pre>
</blockquote>
<p>3.准备<a href="https://wiki.ros.org/camera_calibration/Tutorials/MonocularCalibration?action=AttachFile&do=view&target=check-108.pdf">标定板</a>，我使用的是A4纸打印的，矩形的边长是0.0244m，所以是<code>--square 0.0244 </code></p>
<blockquote>
<p>图片是9x7的格子，标定使用的是8x6个内角点，所以下面是<code>--size 8x6</code></p>
</blockquote>
<p> 4.启动标定程序</p>
<pre><code class="&#39;">rosrun camera_calibration cameracalibrator.py --size 8x6 --square 0.0244 image:=/usb_cam/image_raw camera:=/usb_cam
</code></pre>
<p>静置相机，把标定板粘贴在硬纸板&#x2F;硬书上（防止弯曲），左右（x）、上下（y）、前后（size）、旋转（skew），各个距离都完善后进度条都变绿时点击CALIBRATE即可得出相机内参。</p>
<blockquote>
<p>旋转需要有各个角度，俯仰、偏航的旋转，而非竖直旋转</p>
</blockquote>
<h3 id="相机内参使用"><a href="#相机内参使用" class="headerlink" title="相机内参使用"></a>相机内参使用</h3><p>有一个坐标系的事情需要说明，相机中的坐标系是右x下y，比赛的无人机一般是把相机水平朝下放置，而ROS一般坐标系是前x左y上z，所以<strong>视觉的-x才是策略里的y，-y才是策略里的x</strong>，可能这么说有点绕，看看下面的代码会好理解的多。</p>
<pre><code class="python"># 相机内参
cx = ...
cy = ...
fx = ...
fy = ...
# 识别圆获得的像素坐标
pixel_x = ...
pixel_y = ...
# 计算策略代码中需要的圆目标xy
target_x = - (pixel_y - cy) / fy
target_y = - (pixel_x - cx) / fx
</code></pre>
<p>策略获得target_x、target_y后再<strong>乘以相机离地面的高度</strong>即可计算出圆的相对水平距离</p>
<h1 id="YOLO"><a href="#YOLO" class="headerlink" title="YOLO"></a>YOLO</h1><p>使用神经网络时的问题在于，我们的上位机使用的是NUC，用cpu硬跑yolov5能跑到10帧多，但是由于ros callback的机制原因，你可能会发现画面有非常大的延迟，详见<a target="_blank" rel="noopener" href="https://qllokirin.github.io/2023/06/09/17.callback/">此处</a></p>
<h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>不优雅，但能用，将输入给yolo的数据控制在10Hz，因为计算一帧的时间小于0.1s，所以能比较实时的输出结果，至少没有大延迟。</p>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>使用<code>while not rospy.is_shutdown()</code>，目测rospy会自动开一个线程及时调用回调函数，不论while中运行的是什么，花费了多少时间，参照下面的写法即可</p>
<pre><code class="python">def imgmsg_to_cv2(img_msg):
    # ros图像转cv图像
    ...
    # 获取图像和消息的时间戳
    return image_opencv, img_msg.header.seq  

def task(img_origin):
    # 输入图片，使用模型进行推理的代码放在此处
    ...

img_ros_data = None
seq_current = None
# 这个回调函数会实时调用，来了一个消息就会调用，不会被主线程卡住，只负责更新图像变量
def image_callback(data):
    global img_ros_data, seq_current
    img_ros_data, seq_current = imgmsg_to_cv2(data)

if __name__ == &quot;__main__&quot;:
    rospy.init_node(&#39;yolo_node&#39;, anonymous=True)
    # YoloTypeAndCoordinate 是自定义消息
    info_pub = rospy.Publisher(&#39;/yolo/detect&#39;, YoloTypeAndCoordinate, queue_size=1)
    img_pub = rospy.Publisher(&#39;/yolo/detect_img&#39;, Image, queue_size=1)
    rospy.Subscriber(&#39;/usb_cam/image_raw&#39;, Image, image_callback)

    # 获取上一次的时间戳，当时间戳相同（没有新图像发布）时不推理（不发布结果消息）
    seq_last_time = None
    while not rospy.is_shutdown():
        # img_ros_data和seq_current都不是None也就是最开始启动的时候没有图像消息时也不推理（不发布结果消息）
        if (img_ros_data or seq_current) is not None and seq_current != seq_last_time:
            seq_last_time = seq_current
            task(img_ros_data)
</code></pre>
<blockquote>
<p>yolo训练过程相信视觉的朋友都会，但后续我打算补一个详细流程，方便我自己以后可能用（</p>
</blockquote>
<h1 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h1><h3 id="ros如何在a功能包中使用b功能包定义的数据类型"><a href="#ros如何在a功能包中使用b功能包定义的数据类型" class="headerlink" title="ros如何在a功能包中使用b功能包定义的数据类型"></a>ros如何在a功能包中使用b功能包定义的数据类型</h3><p>比如视觉自定义了一个消息类型传输结果内容，策略如何导入这个消息，以前一直在用<code>../../</code>什么的，当文件夹位置变化时需要修改，比较麻烦，建议用下面的方法，还可以防止<code>catkin_make</code>多线程编译报错</p>
<p>1.在自己的功能包的 <code>CMakeLists.txt</code>添加对b包的依赖</p>
<pre><code>find_package(catkin REQUIRED COMPONENTS
  roscpp
  rospy
  std_msgs
  b_package
)
</code></pre>
<p>2.在 <code>package.xml</code> 文件中添加对 b包的依赖。</p>
<pre><code>&lt;depend&gt;b_package&lt;/depend&gt;
</code></pre>
<p>3.导入头文件</p>
<pre><code class="c++">#include &lt;b_package/YourMessageType.h&gt;
</code></pre>
<pre><code class="python">from b_package.msg import YourMessageType
</code></pre>

        </article>
        
        <section class="post-near">
            <ul>
                
                    <li>上一篇: <a href="/7777/07/07/diary/">稀疏平常的生活</a></li>
                
                
                    <li>下一篇: <a href="/2024/04/11/25.N100_op/">N100双网口小主机使用docker版openwrt做主路由（PPPoE拨号）超详细！！！！</a></li>
                
            </ul>
        </section>
        
            <section class="post-tags">
            <a class="-none-link" href="/tags/%E8%A7%86%E8%A7%89/" rel="tag">视觉</a>
            </section>
        
        <script src="https://giscus.app/client.js"
        data-repo="qllokirin/hexo_blog_comments"
        data-repo-id="R_kgDOI8fvWA"
        data-category="Announcements"
        data-category-id="DIC_kwDOI8fvWM4CUIlh"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
        </script>
    
        <section class="post-author">
        
            <figure class="author-avatar">
                <img src="https://s2.loli.net/2022/09/27/6rzl4WOitu8pUqg.jpg" alt="qllokirin" />
            </figure>
        
            <div class="author-info">
                <h4>qllokirin</h4>
                <p>你好，我是祈菱不是麒麟(qllokirin)，很高兴与你相遇</p>
            </div>
        </section>
    
    </div>
</main>

    <footer>
    <div class="buttons">
        <a class="to-top" href="#"></a>
    </div>
    <div class="wrap min">
        <section class="widget">
            <div class="row">
                <div class="col-m-4">
                    <h3 class="title-recent">最新文章：</h3>
                    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/7777/07/07/diary/">稀疏平常的生活</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/08/05/26.vison_note/">一些视觉代码使用的记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/04/11/25.N100_op/">N100双网口小主机使用docker版openwrt做主路由（PPPoE拨号）超详细！！！！</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/03/22/24.gitea+DroneCI/">gitea+Drone CI实现hexo博客自动部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/02/19/23.remote_control_switch/">宿舍遥控开关整改计划</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/02/14/22.home_network_upgrade/">家庭网络拓扑整改日记</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-date">时光机：</h3>
                    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/7777/07/">July 7777</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-tags">标签云：</h3>
                    <a href="/tags/Drone-CI/" style="font-size: 10px;">Drone CI</a> <a href="/tags/EasyConnect/" style="font-size: 10px;">EasyConnect</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/clash/" style="font-size: 10px;">clash</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/hexo/" style="font-size: 20px;">hexo</a> <a href="/tags/livehouse/" style="font-size: 10px;">livehouse</a> <a href="/tags/openwrt/" style="font-size: 20px;">openwrt</a> <a href="/tags/px4/" style="font-size: 10px;">px4</a> <a href="/tags/ros/" style="font-size: 20px;">ros</a> <a href="/tags/tmux/" style="font-size: 10px;">tmux</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/vocaloid/" style="font-size: 10px;">vocaloid</a> <a href="/tags/%E4%BA%91%E5%B4%BD/" style="font-size: 10px;">云崽</a> <a href="/tags/%E5%8F%8C%E7%AC%99/" style="font-size: 10px;">双笙</a> <a href="/tags/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">家庭网络</a> <a href="/tags/%E6%97%85%E6%B8%B8/" style="font-size: 10px;">旅游</a> <a href="/tags/%E6%97%A0%E4%BA%BA%E6%9C%BA%E7%BB%84%E8%A3%85/" style="font-size: 10px;">无人机组装</a> <a href="/tags/%E6%97%A5%E8%AE%B0/" style="font-size: 10px;">日记</a> <a href="/tags/%E6%AD%8C/" style="font-size: 10px;">歌</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">测试</a> <a href="/tags/%E7%95%AA/" style="font-size: 10px;">番</a> <a href="/tags/%E7%AC%94%E8%AE%B0%E6%9C%AC%E4%BC%98%E5%8C%96/" style="font-size: 10px;">笔记本优化</a> <a href="/tags/%E8%A3%85%E6%9C%BA/" style="font-size: 10px;">装机</a> <a href="/tags/%E8%A7%86%E8%A7%89/" style="font-size: 10px;">视觉</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E8%B7%AF%E7%94%B1%E5%99%A8/" style="font-size: 10px;">路由器</a> <a href="/tags/%E9%81%A5%E6%8E%A7%E5%BC%80%E5%85%B3/" style="font-size: 10px;">遥控开关</a> <a href="/tags/%E9%87%8D%E8%A3%85/" style="font-size: 10px;">重装</a> <a href="/tags/%E9%AD%94%E6%B3%95/" style="font-size: 10px;">魔法</a>
                </div>
            </div>
        </section>
        <section class="sub-footer">
            <p>© 2024 <a href="/">qllokirin</a>. All Rights Reserved. Theme By <a href="https://github.com/Dreamer-Paul/Hingle" target="_blank" rel="nofollow">Hingle</a>.</p>
        </section>
    </div>
</footer>


<script src="/static/kico.js"></script>
<script src="/static/hingle.js"></script>


<script>var hingle = new Paul_Hingle({"copyright":false,"night":false});</script>

  </body>
</html>
